name       : virtualbox
version    : 5.2.22
release    : 83
source     :
    - https://download.virtualbox.org/virtualbox/5.2.22/VirtualBox-5.2.22.tar.bz2 : 5580e875349341a1aabc6d5d2f697d242f277487316faaf1fbe68d9014f788d4
    - git|https://github.com/jwrdegoede/vboxsf.git : 0e8d9459e500d2a465c0074db6f7f8fdad6de1a7
license    : GPL-2.0-only
component  :
    - virt
    - common : virt
    - current : virt
    - guest : virt
    - guest-common : virt
    - guest-current : virt
summary    :
    - VirtualBox host modules for the linux-lts kernel
    - common : Common components for VirtualBox host packages
    - current : VirtualBox host modules for the linux-current kernel
    - devel : Development components for VirtualBox
    - guest : VirtualBox guest additions for the linux-lts kernel
    - guest-current : VirtualBox guest additions for the linux-current kernel
    - guest-common : Common components for the VirtualBox guest packages
description: |
    VirtualBox is a free powerful open source solution for running other x86 and x86_64 operating systems virtually on your computer.

    Installation Guide: https://getsol.us/articles/software/virtualbox/en/
builddeps  :
    - pkgconfig(alsa)
    - pkgconfig(devmapper)
    - pkgconfig(glu)
    - pkgconfig(libcap)
    - pkgconfig(libcurl)
    - pkgconfig(libelf)
    - pkgconfig(libIDL-2.0)
    - pkgconfig(libpng)
    - pkgconfig(libpulse)
    - pkgconfig(libxslt)
    - pkgconfig(opus)
    - pkgconfig(Qt5UiTools)
    - pkgconfig(Qt5X11Extras)
    - pkgconfig(SDL_ttf)
    - pkgconfig(vpx)
    - pkgconfig(xcomposite)
    - pkgconfig(xcursor)
    - pkgconfig(xinerama)
    - pkgconfig(xmu)
    - pkgconfig(xorg-server)
    - pkgconfig(xrandr)
    - acpica-unix
    - cdrtools
    - docbook-xml
    - git
    - glibc-32bit-devel
    - libgcc-32bit
    - linux-current
    - linux-current-headers
    - linux-lts
    - linux-lts-headers
permanent  :
    - /lib/modules
autodep    : no
rundeps    :
    - linux-lts
    - virtualbox-common
    - common :
        - libxcursor
        - libxinerama
        - libxmu
        - qt5-x11extras
        - sdl1
    - current :
        - linux-current
        - virtualbox-common
    - devel :
        - virtualbox-common
    - guest :
        - linux-lts
        - virtualbox-guest-common
    - guest-common :
        - libxcomposite
        - libxdamage
        - libxfixes
        - libxmu
        - libxrandr
        - pam
    - guest-current :
        - linux-current
        - virtualbox-guest-common
patterns   :
    - common : /usr
    - devel :
        - /usr/lib/python2.7
        - /usr/lib64/virtualbox/sdk
    - current : /lib/modules/*.current/extra
    - guest :
        - /lib/modules/*.lts/misc
        - /sbin
    - guest-current : /lib/modules/*.current/misc
    - guest-common :
        - /usr/sbin
        - /usr/bin/VBoxClient
        - /usr/bin/VBoxControl
        - /usr/bin/VBoxClient-all
        - /lib/security
        - /usr/lib64/vboxguestadditions
        - /usr/lib64/udev/rules.d/60-vboxguest.rules
        - /usr/lib64/modules-load.d/vboxguest.conf
        - /usr/lib64/sysusers.d/vboxguest.conf
        - /usr/lib64/systemd/system/vboxservice.service
        - /usr/lib64/systemd/system/multi-user.target.wants/vboxservice.service
        - /usr/share/xdg
setup      : |
    # Apply patches before we go off changing the tree
    %apply_patches

    # Ensure we don't ever use bundled libraries
    rm -rf src/libs/{libpng-*,libxml2-*,libxslt-*,zlib-*,boost-*}

    cp $pkgfiles/LocalConfig.kmk .
    echo "VBOX_GCC_OPT=$CXXFLAGS" >> LocalConfig.kmk

    ./configure --disable-kmods \
                --disable-docs \
                --disable-java \
                --with-makeself=/bin/true   # we don't need this guy; it's used by linux installer
build      : |
    source ./env.sh
    kmk all

    ##### hosts modules #####
    cd out/linux.amd64/release/bin
    for kern in "%kernel_version_lts%" "%kernel_version_current%"; do
        cp -a src ${kern}
        pushd ${kern}
            %make KERN_VER=${kern}
        popd
    done

    ##### guest modules #####
    cd additions
    cp -a src "%kernel_version_lts%"
    pushd "%kernel_version_lts%"
        %make all KERN_VER=%kernel_version_lts%
    popd
install    : |
    ##### Host #####
    cd out/linux.amd64/release/bin

    # binaries
    install -d -m 00755 $installdir/usr/bin
    install -m 00755 VBox.sh $installdir/usr/bin/VBox.sh

    for i in VirtualBox VBoxManage VBoxSDL VBoxHeadless VBoxAutostart VBoxBalloonCtrl VBoxBugReport VBoxDTrace; do
        ln -s VBox.sh $installdir/usr/bin/$i
    done
    install -m 00755 VBoxTunctl $installdir/usr/bin
    install -m 00755 rdesktop-vrdp $installdir/usr/bin

    # libraries
    install -d -m 00755 $installdir/%libdir%/virtualbox
    install -m 00755 *.so -t $installdir/%libdir%/virtualbox
    install -m 00644 *.rc *.r0 VBoxEFI*.fd -t $installdir/%libdir%/virtualbox
    install -m 00755 VBoxManage VBoxSVC VBoxExtPackHelperApp VBoxXPCOMIPCD VBoxTestOGL VBoxBalloonCtrl -t $installdir/%libdir%/virtualbox
    install -m 00755 VBoxCreateUSBNode.sh VBoxSysInfo.sh -t $installdir/%libdir%/virtualbox
    # setuid root binaries
    install -m 04755 VBoxSDL VirtualBox VBoxHeadless VBoxNetDHCP VBoxNetAdpCtl VBoxNetNAT -t $installdir/%libdir%/virtualbox

    # components
    install -d -m 00755 $installdir/%libdir%/virtualbox/components
    install -m 00755 components/* -t $installdir/%libdir%/virtualbox/components

    # languages
    install -d -m 00755 $installdir/usr/share/virtualbox/nls
    install -m 00755 nls/*.qm -t $installdir/usr/share/virtualbox/nls

    # rdesktop keymaps
    install -d -m 00755 $installdir/usr/share/virtualbox/rdesktop-vrdp-keymaps
    install -m 00644 rdesktop-vrdp-keymaps/* -t $installdir/usr/share/virtualbox/rdesktop-vrdp-keymaps

    # icons
    install -D -m 00644 VBox.png $installdir/usr/share/pixmaps/VBox.png
    pushd icons
        for i in *; do
            install -d $installdir/usr/share/icons/hicolor/$i/mimetypes
            cp $i/* $installdir/usr/share/icons/hicolor/$i/mimetypes
        done
    popd

    # .desktop
    install -D -m 00644 virtualbox.desktop $installdir/usr/share/applications/virtualbox.desktop
    install -D -m 00644 virtualbox.xml $installdir/usr/share/mime/packages/virtualbox.xml

    # kernel modules
    for kern in "%kernel_version_lts%" "%kernel_version_current%"; do
        pushd ${kern}
            install -d -m 00755 $installdir/lib/modules/${kern}/extra
            install -m 00644 *.ko $installdir/lib/modules/${kern}/extra
        popd
    done

    # devel
    install -D -m 00755 vboxshell.py $installdir/%libdir%/virtualbox/vboxshell.py
    pushd sdk/installer
        VBOX_INSTALL_PATH="%libdir%/virtualbox" python vboxapisetup.py install --root=$installdir
    popd
    install -d -m 00755 $installdir/%libdir%/virtualbox/sdk/bindings
    cp -r sdk/bindings/{VirtualBox.xidl,auth,xpcom} $installdir/%libdir%/virtualbox/sdk/bindings

    # systemd stuffs
    install -D -m 00644 $pkgfiles/virtualbox.sysusers $installdir/%libdir%/sysusers.d/virtualbox.conf
    install -D -m 00644 $pkgfiles/60-vboxdrv.rules $installdir/%libdir%/udev/rules.d/60-vboxdrv.rules
    install -D -m 00755 $pkgfiles/vboxdrv.sh $installdir/%libdir%/virtualbox/vboxdrv.sh
    install -D -m 00644 $pkgfiles/vboxdrv.service $installdir/%libdir%/systemd/system/vboxdrv.service
    install -d -m 00755 $installdir/%libdir%/systemd/system/multi-user.target.wants
    ln -sv ../vboxdrv.service $installdir/%libdir%/systemd/system/multi-user.target.wants/.

    ##### Guest #####
    cd additions
    install -D -m 00755 mount.vboxsf -t $installdir/sbin
    install -D -m 00755 VBoxService -t $installdir/usr/sbin
    install -m 00755 VBoxClient VBoxControl -t $installdir/usr/bin
    install -D -m 00755 $workdir/src/VBox/Additions/x11/Installer/98vboxadd-xclient $installdir/usr/bin/VBoxClient-all

    install -D -m 00644 $workdir/src/VBox/Additions/x11/Installer/vboxclient.desktop $installdir/usr/share/xdg/autostart/vboxclient.desktop

    install -D -m 00755 pam_vbox.so -t $installdir/lib/security
    install -D -m 00755 VBoxOGL*.so -t $installdir/%libdir%/vboxguestadditions

    # lts kernel modules
    pushd %kernel_version_lts%
        install -d -m 00755 $installdir/lib/modules/%kernel_version_lts%/misc
        install -m 00644 *.ko $installdir/lib/modules/%kernel_version_lts%/misc
    popd

    # build vboxsf module from git for current kernel until it is mainlined
    cp -a $sources/vboxsf.git .
    pushd vboxsf.git
        sed "s|\`uname -r\`|%kernel_version_current%|" -i Makefile
        %make
        install -D -m 00644 vboxsf.ko $installdir/lib/modules/%kernel_version_current%/misc/vboxsf.ko
    popd

    install -D -m 00644 $pkgfiles/vboxguest.modules $installdir/%libdir%/modules-load.d/vboxguest.conf
    install -D -m 00644 $pkgfiles/vboxguest.sysusers $installdir/%libdir%/sysusers.d/vboxguest.conf
    install -D -m 00644 $pkgfiles/60-vboxguest.rules $installdir/%libdir%/udev/rules.d/60-vboxguest.rules
    install -D -m 00644 $pkgfiles/vboxservice.service $installdir/%libdir%/systemd/system/vboxservice.service
    ln -sv ../vboxservice.service $installdir/%libdir%/systemd/system/multi-user.target.wants/.
